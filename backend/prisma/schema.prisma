generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// MULTI-TENANCY CORE MODELS
// ============================================================================

model Startup {
  id                 String   @id @default(cuid())
  name               String
  subscriptionPlan   String   @default("pro_trial") // pro_trial, starter, pro, enterprise
  subscriptionStatus String   @default("active") // active, cancelled, expired
  trialEndsAt        DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  users            User[]
  mockBankAccounts MockBankAccount[]
  transactions     Transaction[]
  products         Product[]
  sales            Sale[]
  cashflowMetrics  CashflowMetric[]
  scenarios        AIScenario[]
  alerts           Alert[]
  investorUpdates  InvestorUpdate[]
  partyMasters     PartyMaster[]
  importedTransactions ImportedTransaction[]
  importHistories  ImportHistory[]
  companyProfile   CompanyProfile?
  fiscalConfig     CompanyFiscalConfig?
  securityConfig   CompanySecuritySetting?
  currencyConfig   CompanyCurrencySetting?
  featureToggle    CompanyFeatureToggle?
  voucherTypes     VoucherType[]
  voucherSeries    VoucherNumberingSeries[]
  vouchers         Voucher[]
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String?
  lastName  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  roles UserRole[]
}

model Role {
  id          String       @id @default(cuid())
  name        String       @unique // e.g., "Admin", "Accountant", "CTO", "CFO", "Operations Manager"
  description String?
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  permissions Permission[]
  users       UserRole[]
}

model Permission {
  id          String   @id @default(cuid())
  action      String   // e.g., "manage", "create", "read", "update", "delete"
  subject     String   // e.g., "users", "transactions", "inventory", "dashboard", "analytics"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles Role[]

  @@unique([action, subject])
}

model UserRole {
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([userId, roleId])
}

// ============================================================================
// SIMULATED FINANCIAL DATA MODELS
// ============================================================================
model CompanyProfile {
  id              String   @id @default(cuid())
  startupId       String   @unique
  displayName     String
  legalName       String?
  mailingName     String?
  baseCurrency    String   @default("INR")
  country         String?
  state           String?
  city            String?
  postalCode      String?
  phone           String?
  mobile          String?
  email           String?
  website         String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  startup   Startup          @relation(fields: [startupId], references: [id], onDelete: Cascade)
  addresses CompanyAddress[]

  @@index([startupId])
}

model CompanyAddress {
  id           String   @id @default(cuid())
  profileId    String
  label        String?
  line1        String
  line2        String?
  city         String?
  state        String?
  country      String?
  postalCode   String?
  isPrimary    Boolean  @default(false)
  isBilling    Boolean  @default(false)
  isShipping   Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  profile CompanyProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([isPrimary])
}

model CompanyFiscalConfig {
  id                     String   @id @default(cuid())
  startupId              String   @unique
  financialYearStart     DateTime
  booksStart             DateTime
  allowBackdatedEntries  Boolean  @default(true)
  backdatedFrom          DateTime?
  enableEditLog          Boolean  @default(false)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  startup Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
}

model CompanySecuritySetting {
  id                        String   @id @default(cuid())
  startupId                 String   @unique
  tallyVaultEnabled         Boolean  @default(false)
  tallyVaultPasswordHash    String?
  tallyVaultPasswordHint    String?
  userAccessControlEnabled  Boolean  @default(false)
  multiFactorRequired       Boolean  @default(false)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  startup Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
}

model CompanyCurrencySetting {
  id                    String   @id @default(cuid())
  startupId             String   @unique
  baseCurrencyCode      String   @default("INR")
  baseCurrencySymbol    String   @default("â‚¹")
  baseCurrencyFormalName String? 
  decimalPlaces         Int      @default(2)
  decimalSeparator      String   @default(".")
  thousandSeparator     String   @default(",")
  symbolOnRight         Boolean  @default(false)
  spaceBetweenAmountAndSymbol Boolean @default(false)
  showAmountInMillions  Boolean  @default(false)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  startup Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
}

model CompanyFeatureToggle {
  id                          String   @id @default(cuid())
  startupId                   String   @unique
  enableAccounting            Boolean  @default(true)
  enableInventory             Boolean  @default(true)
  enableTaxation              Boolean  @default(true)
  enablePayroll               Boolean  @default(false)
  enableAIInsights            Boolean  @default(true)
  enableScenarioPlanning      Boolean  @default(true)
  enableAutomations           Boolean  @default(false)
  enableVendorManagement      Boolean  @default(false)
  enableBillingAndInvoicing   Boolean  @default(true)
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  startup Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
}

enum VoucherCategory {
  PAYMENT
  RECEIPT
  CONTRA
  JOURNAL
  SALES
  PURCHASE
  DEBIT_NOTE
  CREDIT_NOTE
  MEMO
  REVERSING_JOURNAL
  OPTIONAL
  DELIVERY_NOTE
  RECEIPT_NOTE
  REJECTION_IN
  REJECTION_OUT
  STOCK_JOURNAL
  PHYSICAL_STOCK
  JOB_WORK_IN
  JOB_WORK_OUT
  MATERIAL_IN
  MATERIAL_OUT
}

enum VoucherNumberingMethod {
  NONE
  MANUAL
  AUTOMATIC
  AUTOMATIC_WITH_OVERRIDE
  MULTI_USER_AUTO
}

enum VoucherNumberingBehavior {
  RENUMBER
  RETAIN
}

model VoucherType {
  id                   String                 @id @default(cuid())
  startupId            String
  name                 String
  abbreviation         String?
  category             VoucherCategory
  isDefault            Boolean                @default(false)
  numberingMethod      VoucherNumberingMethod @default(AUTOMATIC)
  numberingBehavior    VoucherNumberingBehavior @default(RENUMBER)
  nextNumber           Int                    @default(1)
  prefix               String?
  suffix               String?
  allowManualOverride  Boolean                @default(false)
  allowDuplicateNumbers Boolean               @default(false)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt

  startup        Startup                 @relation(fields: [startupId], references: [id], onDelete: Cascade)
  numberingSeries VoucherNumberingSeries[]
  vouchers        Voucher[]

  @@unique([startupId, name])
  @@index([startupId, category])
}

model VoucherNumberingSeries {
  id                   String                 @id @default(cuid())
  startupId            String
  voucherTypeId        String
  name                 String
  prefix               String?
  suffix               String?
  startNumber          Int                    @default(1)
  nextNumber           Int                    @default(1)
  numberingMethod      VoucherNumberingMethod @default(AUTOMATIC)
  numberingBehavior    VoucherNumberingBehavior @default(RENUMBER)
  allowManualOverride  Boolean                @default(false)
  allowDuplicateNumbers Boolean               @default(false)
  isDefault            Boolean                @default(false)
  createdAt            DateTime               @default(now())
  updatedAt            DateTime               @updatedAt

  startup     Startup     @relation(fields: [startupId], references: [id], onDelete: Cascade)
  voucherType VoucherType @relation(fields: [voucherTypeId], references: [id], onDelete: Cascade)
  vouchers    Voucher[]

  @@unique([voucherTypeId, name])
  @@index([startupId, voucherTypeId])
}

model Voucher {
  id                String      @id @default(cuid())
  startupId         String
  voucherTypeId     String
  numberingSeriesId String?
  voucherNumber     String
  date              DateTime    @default(now())
  reference         String?
  narration         String?
  createdById       String?
  transactionId     String?     @unique
  totalAmount       Decimal     @default(0)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  startup         Startup                 @relation(fields: [startupId], references: [id], onDelete: Cascade)
  voucherType     VoucherType             @relation(fields: [voucherTypeId], references: [id], onDelete: Cascade)
  numberingSeries VoucherNumberingSeries? @relation(fields: [numberingSeriesId], references: [id], onDelete: SetNull)
  transaction     Transaction?            @relation("TransactionVoucher", fields: [transactionId], references: [id], onDelete: SetNull)
  entries         VoucherEntry[]

  @@unique([startupId, voucherTypeId, voucherNumber])
  @@index([startupId, date])
}

enum VoucherEntryType {
  DEBIT
  CREDIT
}

enum VoucherBillReferenceType {
  AGAINST
  NEW
  ADVANCE
  ON_ACCOUNT
}

model VoucherEntry {
  id             String           @id @default(cuid())
  voucherId      String
  ledgerName     String
  ledgerCode     String?
  entryType      VoucherEntryType
  amount         Decimal
  narration      String?
  costCenterName String?
  costCategory   String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt

  voucher       Voucher               @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  billReferences VoucherBillReference[]

  @@index([voucherId])
}

model VoucherBillReference {
  id             String                   @id @default(cuid())
  voucherEntryId String
  reference      String
  referenceType  VoucherBillReferenceType @default(AGAINST)
  amount         Decimal
  dueDate        DateTime?
  remarks        String?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt

  voucherEntry VoucherEntry @relation(fields: [voucherEntryId], references: [id], onDelete: Cascade)

  @@index([voucherEntryId])
}

enum TransactionType {
  CREDIT
  DEBIT
}

model MockBankAccount {
  id          String   @id @default(cuid())
  accountName String   // e.g., "Main Checking Account"
  balance     Float    @default(0.0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  transactions Transaction[]
}

model Transaction {
  id          String          @id @default(cuid())
  amount      Float
  type        TransactionType
  description String
  date        DateTime        @default(now())
  
  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  accountId String
  account   MockBankAccount @relation(fields: [accountId], references: [id])

  sale Sale?
  voucher Voucher? @relation("TransactionVoucher")
}

// ============================================================================
// INVENTORY MANAGEMENT MODELS
// ============================================================================

model Product {
  id        String   @id @default(cuid())
  name      String
  quantity  Int
  price     Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)
  
  sales Sale[]
}

model Sale {
  id           String   @id @default(cuid())
  quantitySold Int
  totalPrice   Float
  saleDate     DateTime @default(now())

  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  transactionId String      @unique
  transaction   Transaction @relation(fields: [transactionId], references: [id])
}

// ============================================================================
// AI CFO FEATURES - ANALYTICS & METRICS
// ============================================================================

model CashflowMetric {
  id           String   @id @default(cuid())
  startupId    String
  periodStart  DateTime
  periodEnd    DateTime
  
  // Core Metrics
  totalRevenue          Decimal @default(0)
  totalExpenses         Decimal @default(0)
  netCashflow           Decimal @default(0)
  burnRate              Decimal @default(0) // Monthly burn rate
  runway                Decimal @default(0) // Months of runway
  
  // Revenue Metrics
  mrr                   Decimal @default(0) // Monthly Recurring Revenue
  arr                   Decimal @default(0) // Annual Recurring Revenue
  growthRate            Decimal @default(0) // Month-over-month growth %
  
  // Balance Metrics
  cashBalance           Decimal @default(0)
  accountsReceivable    Decimal @default(0)
  accountsPayable       Decimal @default(0)
  
  // Customer Metrics (from inventory sales)
  activeCustomers       Int     @default(0)
  newCustomers          Int     @default(0)
  churnedCustomers      Int     @default(0)
  customerAcquisitionCost Decimal @default(0)
  lifetimeValue         Decimal @default(0)
  
  // Inventory Metrics
  totalInventoryValue   Decimal @default(0)
  inventoryTurnover     Decimal @default(0)
  
  // Additional Metrics
  metadata              Json?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  startup   Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)
  
  @@index([startupId, periodStart])
}

// ============================================================================
// AI CFO FEATURES - SCENARIOS & FORECASTING
// ============================================================================

model AIScenario {
  id               String   @id @default(cuid())
  startupId        String
  name             String
  description      String?
  scenarioType     String   // forecast, what_if, sensitivity, stress_test
  
  // Input Parameters
  inputParameters  Json     // Store scenario variables (e.g., revenue growth %, cost reduction %)
  
  // AI-Generated Results
  projectedRevenue  Decimal?
  projectedExpenses Decimal?
  projectedCashflow Decimal?
  projectedRunway   Decimal?
  projectedMRR      Decimal?
  projectedARR      Decimal?
  confidence        Decimal? // AI confidence score 0-100
  
  // AI Insights
  insights          Json?    // Array of AI-generated insights
  recommendations   Json?    // Array of AI recommendations
  risks             Json?    // Array of identified risks
  opportunities     Json?    // Array of identified opportunities
  
  // Metadata
  createdBy    String?  // User ID who created this scenario
  isBookmarked Boolean  @default(false)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  startup   Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)
  
  @@index([startupId, createdAt])
}

// ============================================================================
// AI CFO FEATURES - ALERTS & NOTIFICATIONS
// ============================================================================

model Alert {
  id          String   @id @default(cuid())
  startupId   String
  type        String   // runway, burn_rate, anomaly, cash_low, churn, inventory_low
  severity    String   // info, warning, critical
  title       String
  message     String   @db.Text
  
  // Alert Data
  currentValue   Decimal?
  thresholdValue Decimal?
  
  // AI-Generated Recommendations
  recommendations Json? // Array of actionable recommendations
  
  // Related Entity (optional)
  relatedEntityType String? // product, transaction, account
  relatedEntityId   String?
  
  // Status
  isRead      Boolean  @default(false)
  isDismissed Boolean  @default(false)
  dismissedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  startup   Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)
  
  @@index([startupId, createdAt])
  @@index([startupId, isRead])
}

// ============================================================================
// AI CFO FEATURES - INVESTOR UPDATES
// ============================================================================

model InvestorUpdate {
  id           String   @id @default(cuid())
  startupId    String
  title        String
  periodStart  DateTime
  periodEnd    DateTime
  
  // Key Metrics Summary
  metrics      Json     // Snapshot of key metrics
  
  // AI-Generated Content
  executiveSummary String @db.Text
  highlights       Json   // Array of highlights
  challenges       Json   // Array of challenges
  nextSteps        Json   // Array of next steps
  financialData    Json?  // Detailed financial breakdown
  
  // Financial Data
  revenueGrowth Decimal?
  burnRate      Decimal?
  runway        Decimal?
  
  // Status
  isDraft     Boolean   @default(true)
  publishedAt DateTime?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  startup   Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)
  
  @@index([startupId, periodStart])
}

// ============================================================================
// TALLY IMPORT DATA MODELS
// ============================================================================

model PartyMaster {
  id               String   @id @default(cuid())
  name             String
  type             String   // Customer, Supplier, Employee, Other
  email            String?
  phone            String?
  openingBalance   Float    @default(0.0)
  balanceType      String   // Debit or Credit
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@unique([startupId, name])
  @@index([startupId])
  @@index([type])
}

model ImportedTransaction {
  id          String   @id @default(cuid())
  voucherNo   String
  voucherType String   // Sales, Purchase, Journal, Receipt, Payment, Contra
  date        DateTime
  narration   String
  particulars String
  amount      Float    @default(0.0)
  debit       Float    @default(0.0)
  credit      Float    @default(0.0)
  reference   String?
  ledgerName  String
  createdAt   DateTime @default(now())

  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
  @@index([ledgerName])
  @@index([date])
}

model ImportHistory {
  id           String   @id @default(cuid())
  fileName     String
  importType   String   // TALLY, QUICKBOOKS, etc.
  totalRecords Int
  successCount Int
  failureCount Int
  summary      String   @db.Text // JSON summary of what was imported
  createdAt    DateTime @default(now())

  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
  @@index([createdAt])
}
