generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// MULTI-TENANCY CORE MODELS
// ============================================================================

model Startup {
  id                 String    @id @default(cuid())
  name               String
  subscriptionPlan   String    @default("starter_earlybird") // starter_earlybird, starter, pro, enterprise
  subscriptionStatus String    @default("active") // active, cancelled, expired
  trialEndsAt        DateTime?
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  users                 User[]
  mockBankAccounts      MockBankAccount[]
  transactions          Transaction[]
  products              Product[]
  sales                 Sale[]
  cashflowMetrics       CashflowMetric[]
  scenarios             AIScenario[]
  alerts                Alert[]
  investorUpdates       InvestorUpdate[]
  partyMasters          PartyMaster[]
  importedTransactions  ImportedTransaction[]
  importHistories       ImportHistory[]
  ledgerGroups          LedgerGroup[]
  ledgers               Ledger[]
  companyProfile        CompanyProfile?
  fiscalConfig          CompanyFiscalConfig?
  securityConfig        CompanySecuritySetting?
  currencyConfig        CompanyCurrencySetting?
  featureToggle         CompanyFeatureToggle?
  voucherTypes          VoucherType[]
  voucherSeries         VoucherNumberingSeries[]
  vouchers              Voucher[]
  bills                 Bill[]
  billSettlements       BillSettlement[]
  costCategories        CostCategory[]
  costCenters           CostCenter[]
  interestProfiles      InterestProfile[]
  partyInterestSettings PartyInterestSetting[]
  gstRegistrations      GstRegistration[]
  gstTaxRates           GstTaxRate[]
  gstLedgerMappings     GstLedgerMapping[]
  auditLogs             AuditLog[]
  itemMasters           ItemMaster[]
  warehouses            WarehouseMaster[]
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  firstName String?
  lastName  String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  roles     UserRole[]
  auditLogs AuditLog[]
}

model Role {
  id          String   @id @default(cuid())
  name        String   @unique // e.g., "Admin", "Accountant", "CTO", "CFO", "Operations Manager"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  permissions Permission[]
  users       UserRole[]
}

model Permission {
  id          String   @id @default(cuid())
  action      String // e.g., "manage", "create", "read", "update", "delete"
  subject     String // e.g., "users", "transactions", "inventory", "dashboard", "analytics"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles Role[]

  @@unique([action, subject])
}

model UserRole {
  userId String
  roleId String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())

  @@id([userId, roleId])
}

// ============================================================================
// SIMULATED FINANCIAL DATA MODELS
// ============================================================================
model CompanyProfile {
  id           String   @id @default(cuid())
  startupId    String   @unique
  displayName  String
  legalName    String?
  mailingName  String?
  baseCurrency String   @default("INR")
  country      String?
  state        String?
  city         String?
  postalCode   String?
  phone        String?
  mobile       String?
  email        String?
  website      String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  startup   Startup          @relation(fields: [startupId], references: [id], onDelete: Cascade)
  addresses CompanyAddress[]

  @@index([startupId])
}

model CompanyAddress {
  id         String   @id @default(cuid())
  profileId  String
  label      String?
  line1      String
  line2      String?
  city       String?
  state      String?
  country    String?
  postalCode String?
  isPrimary  Boolean  @default(false)
  isBilling  Boolean  @default(false)
  isShipping Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  profile CompanyProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)

  @@index([profileId])
  @@index([isPrimary])
}

model CompanyFiscalConfig {
  id                    String    @id @default(cuid())
  startupId             String    @unique
  financialYearStart    DateTime
  booksStart            DateTime
  allowBackdatedEntries Boolean   @default(true)
  backdatedFrom         DateTime?
  enableEditLog         Boolean   @default(false)
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt

  startup Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
}

model CompanySecuritySetting {
  id                       String   @id @default(cuid())
  startupId                String   @unique
  tallyVaultEnabled        Boolean  @default(false)
  tallyVaultPasswordHash   String?
  tallyVaultPasswordHint   String?
  userAccessControlEnabled Boolean  @default(false)
  multiFactorRequired      Boolean  @default(false)
  createdAt                DateTime @default(now())
  updatedAt                DateTime @updatedAt

  startup Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
}

model CompanyCurrencySetting {
  id                          String   @id @default(cuid())
  startupId                   String   @unique
  baseCurrencyCode            String   @default("INR")
  baseCurrencySymbol          String   @default("â‚¹")
  baseCurrencyFormalName      String?
  decimalPlaces               Int      @default(2)
  decimalSeparator            String   @default(".")
  thousandSeparator           String   @default(",")
  symbolOnRight               Boolean  @default(false)
  spaceBetweenAmountAndSymbol Boolean  @default(false)
  showAmountInMillions        Boolean  @default(false)
  createdAt                   DateTime @default(now())
  updatedAt                   DateTime @updatedAt

  startup Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
}

model CompanyFeatureToggle {
  id                        String   @id @default(cuid())
  startupId                 String   @unique
  enableAccounting          Boolean  @default(true)
  enableInventory           Boolean  @default(true)
  enableTaxation            Boolean  @default(true)
  enablePayroll             Boolean  @default(false)
  enableAIInsights          Boolean  @default(true)
  enableScenarioPlanning    Boolean  @default(true)
  enableAutomations         Boolean  @default(false)
  enableVendorManagement    Boolean  @default(false)
  enableBillingAndInvoicing Boolean  @default(true)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt

  startup Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
}

enum VoucherCategory {
  PAYMENT
  RECEIPT
  CONTRA
  JOURNAL
  SALES
  PURCHASE
  DEBIT_NOTE
  CREDIT_NOTE
  MEMO
  REVERSING_JOURNAL
  OPTIONAL
  DELIVERY_NOTE
  RECEIPT_NOTE
  REJECTION_IN
  REJECTION_OUT
  STOCK_JOURNAL
  PHYSICAL_STOCK
  JOB_WORK_IN
  JOB_WORK_OUT
  MATERIAL_IN
  MATERIAL_OUT
}

enum VoucherStatus {
  DRAFT
  POSTED
  CANCELLED
}

enum PaymentMode {
  CASH
  BANK_TRANSFER
  CHEQUE
  UPI
  NEFT
  RTGS
  OTHER
}

enum VoucherNumberingMethod {
  NONE
  MANUAL
  AUTOMATIC
  AUTOMATIC_WITH_OVERRIDE
  MULTI_USER_AUTO
}

enum VoucherNumberingBehavior {
  RENUMBER
  RETAIN
}

model VoucherType {
  id                    String                   @id @default(cuid())
  startupId             String
  name                  String
  abbreviation          String?
  category              VoucherCategory
  isDefault             Boolean                  @default(false)
  numberingMethod       VoucherNumberingMethod   @default(AUTOMATIC)
  numberingBehavior     VoucherNumberingBehavior @default(RENUMBER)
  nextNumber            Int                      @default(1)
  prefix                String?
  suffix                String?
  allowManualOverride   Boolean                  @default(false)
  allowDuplicateNumbers Boolean                  @default(false)
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt

  startup         Startup                  @relation(fields: [startupId], references: [id], onDelete: Cascade)
  numberingSeries VoucherNumberingSeries[]
  vouchers        Voucher[]

  @@unique([startupId, name])
  @@index([startupId, category])
}

model VoucherNumberingSeries {
  id                    String                   @id @default(cuid())
  startupId             String
  voucherTypeId         String
  name                  String
  prefix                String?
  suffix                String?
  startNumber           Int                      @default(1)
  nextNumber            Int                      @default(1)
  numberingMethod       VoucherNumberingMethod   @default(AUTOMATIC)
  numberingBehavior     VoucherNumberingBehavior @default(RENUMBER)
  allowManualOverride   Boolean                  @default(false)
  allowDuplicateNumbers Boolean                  @default(false)
  isDefault             Boolean                  @default(false)
  createdAt             DateTime                 @default(now())
  updatedAt             DateTime                 @updatedAt

  startup     Startup     @relation(fields: [startupId], references: [id], onDelete: Cascade)
  voucherType VoucherType @relation(fields: [voucherTypeId], references: [id], onDelete: Cascade)
  vouchers    Voucher[]

  @@unique([voucherTypeId, name])
  @@index([startupId, voucherTypeId])
}

model Voucher {
  id                 String        @id @default(cuid())
  startupId          String
  voucherTypeId      String
  numberingSeriesId  String?
  voucherNumber      String
  date               DateTime      @default(now())
  reference          String?
  narration          String?
  createdById        String?
  transactionId      String?       @unique
  totalAmount        Decimal       @default(0)
  status             VoucherStatus @default(DRAFT)
  partyLedgerId      String? // For customer/supplier linking
  paymentMode        PaymentMode?
  placeOfSupplyState String? // State code for GST calculation
  originalInvoiceId  String? // For Credit/Debit Notes linking to original invoice
  billingName        String?
  billingAddress     String?
  customerGstin      String?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  startup         Startup                 @relation(fields: [startupId], references: [id], onDelete: Cascade)
  voucherType     VoucherType             @relation(fields: [voucherTypeId], references: [id], onDelete: Cascade)
  numberingSeries VoucherNumberingSeries? @relation(fields: [numberingSeriesId], references: [id], onDelete: SetNull)
  transaction     Transaction?            @relation("TransactionVoucher", fields: [transactionId], references: [id], onDelete: SetNull)
  partyLedger     Ledger?                 @relation("VoucherPartyLedger", fields: [partyLedgerId], references: [id], onDelete: SetNull)
  entries         VoucherEntry[]
  inventoryLines  VoucherInventoryLine[]
  bills           Bill[] // Bills created from this voucher
  settlements     BillSettlement[] // Settlements made through this voucher

  @@unique([startupId, voucherTypeId, voucherNumber])
  @@index([startupId, date])
  @@index([startupId, status])
  @@index([partyLedgerId])
}

enum VoucherEntryType {
  DEBIT
  CREDIT
}

enum VoucherBillReferenceType {
  AGAINST
  NEW
  ADVANCE
  ON_ACCOUNT
}

model VoucherEntry {
  id             String           @id @default(cuid())
  voucherId      String
  ledgerName     String
  ledgerCode     String?
  ledgerId       String? // Reference to Ledger model for better integrity
  entryType      VoucherEntryType
  amount         Decimal
  narration      String?
  costCenterName String?
  costCategory   String?
  costCenterId   String?
  costCategoryId String?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  voucher         Voucher                @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  ledger          Ledger?                @relation("VoucherEntryLedger", fields: [ledgerId], references: [id], onDelete: SetNull)
  billReferences  VoucherBillReference[]
  bills           Bill[] // Bills created from this entry
  settlements     BillSettlement[] // Settlements made through this entry
  costCenter      CostCenter?            @relation("VoucherEntryCostCenter", fields: [costCenterId], references: [id], onDelete: SetNull)
  costCategoryRef CostCategory?          @relation("VoucherEntryCostCategory", fields: [costCategoryId], references: [id], onDelete: SetNull)

  @@index([voucherId])
  @@index([ledgerId])
}

model VoucherBillReference {
  id             String                   @id @default(cuid())
  voucherEntryId String
  reference      String
  referenceType  VoucherBillReferenceType @default(AGAINST)
  amount         Decimal
  dueDate        DateTime?
  remarks        String?
  createdAt      DateTime                 @default(now())
  updatedAt      DateTime                 @updatedAt

  voucherEntry VoucherEntry @relation(fields: [voucherEntryId], references: [id], onDelete: Cascade)

  @@index([voucherEntryId])
}

// ============================================================================
// BILL-WISE TRACKING MODELS (Receivables/Payables)
// ============================================================================

enum BillType {
  RECEIVABLE // Money owed to us (Sales invoices, advances from customers)
  PAYABLE // Money we owe (Purchase invoices, advances to suppliers)
}

enum BillStatus {
  OPEN // Bill is open and has outstanding amount
  PARTIAL // Partially settled
  SETTLED // Fully settled
  CANCELLED // Cancelled/voided
}

model Bill {
  id                String     @id @default(cuid())
  startupId         String
  billType          BillType
  billNumber        String // Invoice/Bill number
  ledgerName        String // Party/Supplier/Customer ledger name
  ledgerCode        String? // Optional ledger code
  billDate          DateTime   @default(now())
  dueDate           DateTime?
  originalAmount    Decimal // Original bill amount
  settledAmount     Decimal    @default(0) // Total amount settled so far
  outstandingAmount Decimal // Calculated: originalAmount - settledAmount
  status            BillStatus @default(OPEN)
  reference         String? // External reference (PO number, etc.)
  narration         String? // Additional notes
  voucherId         String? // Optional link to the voucher that created this bill
  voucherEntryId    String? // Optional link to the specific voucher entry
  createdAt         DateTime   @default(now())
  updatedAt         DateTime   @updatedAt

  startup      Startup          @relation(fields: [startupId], references: [id], onDelete: Cascade)
  voucher      Voucher?         @relation(fields: [voucherId], references: [id], onDelete: SetNull)
  voucherEntry VoucherEntry?    @relation(fields: [voucherEntryId], references: [id], onDelete: SetNull)
  settlements  BillSettlement[]

  @@unique([startupId, billNumber])
  @@index([startupId, billType, status])
  @@index([startupId, ledgerName])
  @@index([startupId, dueDate])
  @@index([voucherId])
  @@index([voucherEntryId])
}

model BillSettlement {
  id               String   @id @default(cuid())
  startupId        String
  billId           String
  voucherId        String // Voucher that settles this bill (Payment/Receipt)
  voucherEntryId   String // Specific voucher entry that settles
  settlementAmount Decimal // Amount being settled in this transaction
  settlementDate   DateTime @default(now())
  reference        String? // Reference from the settling voucher
  remarks          String? // Additional notes
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  startup      Startup      @relation(fields: [startupId], references: [id], onDelete: Cascade)
  bill         Bill         @relation(fields: [billId], references: [id], onDelete: Cascade)
  voucher      Voucher      @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  voucherEntry VoucherEntry @relation(fields: [voucherEntryId], references: [id], onDelete: Cascade)

  @@index([startupId, billId])
  @@index([startupId, voucherId])
  @@index([startupId, settlementDate])
}

// ============================================================================
// COST CENTRE AND INTEREST CONFIGURATION MODELS
// ============================================================================

enum InterestCalculationMode {
  SIMPLE
  COMPOUND
}

enum InterestCompoundingFrequency {
  NONE
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  YEARLY
}

model CostCategory {
  id          String   @id @default(cuid())
  startupId   String
  name        String
  description String?
  parentId    String?
  isPrimary   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  startup        Startup        @relation(fields: [startupId], references: [id], onDelete: Cascade)
  parent         CostCategory?  @relation("CostCategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children       CostCategory[] @relation("CostCategoryHierarchy")
  costCenters    CostCenter[]
  voucherEntries VoucherEntry[] @relation("VoucherEntryCostCategory")

  @@unique([startupId, name])
  @@index([startupId, parentId])
}

model CostCenter {
  id          String   @id @default(cuid())
  startupId   String
  categoryId  String
  name        String
  code        String?
  description String?
  parentId    String?
  isBillable  Boolean  @default(false)
  status      String   @default("active")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  startup        Startup        @relation(fields: [startupId], references: [id], onDelete: Cascade)
  category       CostCategory   @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  parent         CostCenter?    @relation("CostCenterHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children       CostCenter[]   @relation("CostCenterHierarchy")
  voucherEntries VoucherEntry[] @relation("VoucherEntryCostCenter")

  @@unique([startupId, name, categoryId])
  @@index([startupId, categoryId])
  @@index([startupId, parentId])
}

model InterestProfile {
  id                   String                       @id @default(cuid())
  startupId            String
  name                 String
  description          String?
  calculationMode      InterestCalculationMode      @default(SIMPLE)
  rate                 Decimal                      @default(0)
  compoundingFrequency InterestCompoundingFrequency @default(NONE)
  gracePeriodDays      Int?
  calculateFromDueDate Boolean                      @default(true)
  penalRate            Decimal                      @default(0)
  penalGraceDays       Int?
  createdAt            DateTime                     @default(now())
  updatedAt            DateTime                     @updatedAt

  startup       Startup                @relation(fields: [startupId], references: [id], onDelete: Cascade)
  partySettings PartyInterestSetting[]

  @@unique([startupId, name])
}

model PartyInterestSetting {
  id                 String    @id @default(cuid())
  startupId          String
  partyId            String    @unique
  interestProfileId  String
  overrideRate       Decimal?
  effectiveFrom      DateTime?
  effectiveTo        DateTime?
  applyOnReceivables Boolean   @default(true)
  applyOnPayables    Boolean   @default(false)
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  startup         Startup         @relation(fields: [startupId], references: [id], onDelete: Cascade)
  party           PartyMaster     @relation(fields: [partyId], references: [id], onDelete: Cascade)
  interestProfile InterestProfile @relation(fields: [interestProfileId], references: [id], onDelete: Cascade)

  @@index([startupId, interestProfileId])
}

// ============================================================================
// GST / STATUTORY CONFIGURATION MODELS
// ============================================================================

enum GstRegistrationType {
  REGULAR
  COMPOSITION
  SEZ
  ISD
  TDS
  TCS
}

enum GstTaxSupplyType {
  GOODS
  SERVICES
}

enum GstLedgerMappingType {
  OUTPUT_CGST
  OUTPUT_SGST
  OUTPUT_IGST
  OUTPUT_CESS
  INPUT_CGST
  INPUT_SGST
  INPUT_IGST
  INPUT_CESS
  RCM_PAYABLE
  RCM_INPUT
}

model GstRegistration {
  id               String              @id @default(cuid())
  startupId        String
  gstin            String
  legalName        String?
  tradeName        String?
  registrationType GstRegistrationType @default(REGULAR)
  stateCode        String
  stateName        String?
  startDate        DateTime
  endDate          DateTime?
  isDefault        Boolean             @default(false)
  isActive         Boolean             @default(true)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt

  startup        Startup            @relation(fields: [startupId], references: [id], onDelete: Cascade)
  taxRates       GstTaxRate[]
  ledgerMappings GstLedgerMapping[]

  @@unique([startupId, gstin])
  @@index([startupId, isActive])
  @@index([startupId, isDefault])
}

model GstTaxRate {
  id             String           @id @default(cuid())
  startupId      String
  registrationId String?
  supplyType     GstTaxSupplyType @default(GOODS)
  hsnOrSac       String?
  description    String?
  cgstRate       Decimal          @default(0)
  sgstRate       Decimal          @default(0)
  igstRate       Decimal          @default(0)
  cessRate       Decimal          @default(0)
  effectiveFrom  DateTime?
  effectiveTo    DateTime?
  isActive       Boolean          @default(true)
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  startup      Startup          @relation(fields: [startupId], references: [id], onDelete: Cascade)
  registration GstRegistration? @relation(fields: [registrationId], references: [id], onDelete: SetNull)

  @@index([startupId, supplyType])
  @@index([startupId, hsnOrSac])
  @@index([registrationId])
}

model GstLedgerMapping {
  id             String               @id @default(cuid())
  startupId      String
  registrationId String?
  mappingType    GstLedgerMappingType
  ledgerName     String
  ledgerCode     String?
  description    String?
  createdAt      DateTime             @default(now())
  updatedAt      DateTime             @updatedAt

  startup      Startup          @relation(fields: [startupId], references: [id], onDelete: Cascade)
  registration GstRegistration? @relation(fields: [registrationId], references: [id], onDelete: SetNull)

  @@unique([startupId, mappingType, registrationId])
  @@index([startupId, mappingType])
  @@index([registrationId])
}

enum TransactionType {
  CREDIT
  DEBIT
}

model MockBankAccount {
  id          String   @id @default(cuid())
  accountName String // e.g., "Main Checking Account"
  balance     Float    @default(0.0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  transactions Transaction[]
}

model Transaction {
  id          String          @id @default(cuid())
  amount      Float
  type        TransactionType
  description String
  date        DateTime        @default(now())

  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  accountId String
  account   MockBankAccount @relation(fields: [accountId], references: [id])

  sale    Sale?
  voucher Voucher? @relation("TransactionVoucher")
}

// ============================================================================
// INVENTORY MANAGEMENT MODELS
// ============================================================================

model Product {
  id        String   @id @default(cuid())
  name      String
  quantity  Int
  price     Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  sales Sale[]
}

model Sale {
  id           String   @id @default(cuid())
  quantitySold Int
  totalPrice   Float
  saleDate     DateTime @default(now())

  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  productId String
  product   Product @relation(fields: [productId], references: [id])

  transactionId String      @unique
  transaction   Transaction @relation(fields: [transactionId], references: [id])
}

// ============================================================================
// AI CFO FEATURES - ANALYTICS & METRICS
// ============================================================================

model CashflowMetric {
  id          String   @id @default(cuid())
  startupId   String
  periodStart DateTime
  periodEnd   DateTime

  // Core Metrics
  totalRevenue  Decimal @default(0)
  totalExpenses Decimal @default(0)
  netCashflow   Decimal @default(0)
  burnRate      Decimal @default(0) // Monthly burn rate
  runway        Decimal @default(0) // Months of runway

  // Revenue Metrics
  mrr        Decimal @default(0) // Monthly Recurring Revenue
  arr        Decimal @default(0) // Annual Recurring Revenue
  growthRate Decimal @default(0) // Month-over-month growth %

  // Balance Metrics
  cashBalance        Decimal @default(0)
  accountsReceivable Decimal @default(0)
  accountsPayable    Decimal @default(0)

  // Customer Metrics (from inventory sales)
  activeCustomers         Int     @default(0)
  newCustomers            Int     @default(0)
  churnedCustomers        Int     @default(0)
  customerAcquisitionCost Decimal @default(0)
  lifetimeValue           Decimal @default(0)

  // Inventory Metrics
  totalInventoryValue Decimal @default(0)
  inventoryTurnover   Decimal @default(0)

  // Additional Metrics
  metadata Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  startup   Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId, periodStart])
}

// ============================================================================
// AI CFO FEATURES - SCENARIOS & FORECASTING
// ============================================================================

model AIScenario {
  id           String  @id @default(cuid())
  startupId    String
  name         String
  description  String?
  scenarioType String // forecast, what_if, sensitivity, stress_test

  // Input Parameters
  inputParameters Json // Store scenario variables (e.g., revenue growth %, cost reduction %)

  // AI-Generated Results
  projectedRevenue  Decimal?
  projectedExpenses Decimal?
  projectedCashflow Decimal?
  projectedRunway   Decimal?
  projectedMRR      Decimal?
  projectedARR      Decimal?
  confidence        Decimal? // AI confidence score 0-100

  // AI Insights
  insights        Json? // Array of AI-generated insights
  recommendations Json? // Array of AI recommendations
  risks           Json? // Array of identified risks
  opportunities   Json? // Array of identified opportunities

  // Metadata
  createdBy    String? // User ID who created this scenario
  isBookmarked Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  startup   Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId, createdAt])
}

// ============================================================================
// AI CFO FEATURES - ALERTS & NOTIFICATIONS
// ============================================================================

model Alert {
  id        String @id @default(cuid())
  startupId String
  type      String // runway, burn_rate, anomaly, cash_low, churn, inventory_low
  severity  String // info, warning, critical
  title     String
  message   String @db.Text

  // Alert Data
  currentValue   Decimal?
  thresholdValue Decimal?

  // AI-Generated Recommendations
  recommendations Json? // Array of actionable recommendations

  // Related Entity (optional)
  relatedEntityType String? // product, transaction, account
  relatedEntityId   String?

  // Status
  isRead      Boolean   @default(false)
  isDismissed Boolean   @default(false)
  dismissedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  startup   Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId, createdAt])
  @@index([startupId, isRead])
}

// ============================================================================
// AI CFO FEATURES - INVESTOR UPDATES
// ============================================================================

model InvestorUpdate {
  id          String   @id @default(cuid())
  startupId   String
  title       String
  periodStart DateTime
  periodEnd   DateTime

  // Key Metrics Summary
  metrics Json // Snapshot of key metrics

  // AI-Generated Content
  executiveSummary String @db.Text
  highlights       Json // Array of highlights
  challenges       Json // Array of challenges
  nextSteps        Json // Array of next steps
  financialData    Json? // Detailed financial breakdown

  // Financial Data
  revenueGrowth Decimal?
  burnRate      Decimal?
  runway        Decimal?

  // Status
  isDraft     Boolean   @default(true)
  publishedAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  startup   Startup  @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId, periodStart])
}

// ============================================================================
// TALLY IMPORT DATA MODELS
// ============================================================================

model PartyMaster {
  id             String   @id @default(cuid())
  name           String
  type           String // Customer, Supplier, Employee, Other
  email          String?
  phone          String?
  openingBalance Float    @default(0.0)
  balanceType    String // Debit or Credit
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  startupId       String
  startup         Startup               @relation(fields: [startupId], references: [id], onDelete: Cascade)
  interestSetting PartyInterestSetting?

  @@unique([startupId, name])
  @@index([startupId])
  @@index([type])
}

enum LedgerCategory {
  CAPITAL
  LOAN
  CURRENT_ASSET
  CURRENT_LIABILITY
  SUNDRY_DEBTOR
  SUNDRY_CREDITOR
  BANK_ACCOUNT
  CASH
  INVESTMENT
  STOCK
  PURCHASE
  SALES
  DIRECT_EXPENSE
  DIRECT_INCOME
  INDIRECT_EXPENSE
  INDIRECT_INCOME
  OTHER
}

enum LedgerBalanceType {
  DEBIT
  CREDIT
}

enum LedgerSubtype {
  CASH
  BANK
  CUSTOMER
  SUPPLIER
  SALES
  PURCHASE
  TAX_GST_OUTPUT
  TAX_GST_INPUT
  EXPENSE
  INCOME
  OTHER
}

enum InterestComputation {
  NONE
  SIMPLE
  COMPOUND
}

model LedgerGroup {
  id          String         @id @default(cuid())
  startupId   String
  name        String
  code        String?
  description String?
  category    LedgerCategory
  parentId    String?
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  startup  Startup       @relation(fields: [startupId], references: [id], onDelete: Cascade)
  parent   LedgerGroup?  @relation("LedgerGroupChildren", fields: [parentId], references: [id])
  children LedgerGroup[] @relation("LedgerGroupChildren")
  ledgers  Ledger[]

  @@unique([startupId, name])
  @@index([startupId])
  @@index([startupId, parentId])
}

model Ledger {
  id                      String              @id @default(cuid())
  startupId               String
  groupId                 String
  name                    String
  alias                   String?
  description             String?
  ledgerSubtype           LedgerSubtype? // CASH, BANK, CUSTOMER, SUPPLIER, etc.
  inventoryAffectsStock   Boolean             @default(false)
  maintainBillByBill      Boolean             @default(false)
  defaultCreditPeriodDays Int?
  creditLimit             Decimal?
  interestComputation     InterestComputation @default(NONE)
  interestRate            Decimal?
  penalRate               Decimal?
  interestGraceDays       Int?
  taxNumber               String?
  panNumber               String?
  gstNumber               String?
  mailingAddress          Json?
  bankDetails             Json?
  costCenterApplicable    Boolean             @default(false)
  openingBalance          Decimal?            @default(0)
  openingBalanceType      LedgerBalanceType?  @default(DEBIT)
  metadata                Json?
  createdAt               DateTime            @default(now())
  updatedAt               DateTime            @updatedAt

  startup        Startup        @relation(fields: [startupId], references: [id], onDelete: Cascade)
  group          LedgerGroup    @relation(fields: [groupId], references: [id], onDelete: Cascade)
  vouchers       Voucher[]      @relation("VoucherPartyLedger")
  voucherEntries VoucherEntry[] @relation("VoucherEntryLedger")

  @@unique([startupId, name])
  @@index([startupId])
  @@index([startupId, groupId])
  @@index([startupId, ledgerSubtype])
}

model ImportedTransaction {
  id          String   @id @default(cuid())
  voucherNo   String
  voucherType String // Sales, Purchase, Journal, Receipt, Payment, Contra
  date        DateTime
  narration   String
  particulars String
  amount      Float    @default(0.0)
  debit       Float    @default(0.0)
  credit      Float    @default(0.0)
  reference   String?
  ledgerName  String
  createdAt   DateTime @default(now())

  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
  @@index([ledgerName])
  @@index([date])
}

model ImportHistory {
  id           String   @id @default(cuid())
  fileName     String
  importType   String // TALLY, QUICKBOOKS, etc.
  totalRecords Int
  successCount Int
  failureCount Int
  summary      String   @db.Text // JSON summary of what was imported
  createdAt    DateTime @default(now())

  startupId String
  startup   Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)

  @@index([startupId])
  @@index([createdAt])
}

// ============================================================================
// AUDIT TRAIL / EDIT LOG MODELS
// ============================================================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  VIEW
  EXPORT
  APPROVE
  REJECT
  CANCEL
}

enum AuditEntityType {
  VOUCHER
  VOUCHER_ENTRY
  BILL
  BILL_SETTLEMENT
  COMPANY_PROFILE
  COMPANY_ADDRESS
  FISCAL_CONFIG
  SECURITY_CONFIG
  CURRENCY_CONFIG
  FEATURE_TOGGLE
  VOUCHER_TYPE
  VOUCHER_NUMBERING_SERIES
  COST_CATEGORY
  COST_CENTER
  INTEREST_PROFILE
  PARTY_INTEREST_SETTING
  GST_REGISTRATION
  GST_TAX_RATE
  GST_LEDGER_MAPPING
  PARTY_MASTER
  PRODUCT
  TRANSACTION
  USER
  ROLE
  PERMISSION
}

model AuditLog {
  id          String          @id @default(cuid())
  startupId   String
  userId      String? // User who performed the action
  entityType  AuditEntityType
  entityId    String // ID of the entity that was changed
  action      AuditAction
  description String? // Human-readable description
  oldValues   Json? // Previous state (for UPDATE/DELETE)
  newValues   Json? // New state (for CREATE/UPDATE)
  metadata    Json? // Additional context (IP address, user agent, etc.)
  ipAddress   String?
  userAgent   String?
  createdAt   DateTime        @default(now())

  startup Startup @relation(fields: [startupId], references: [id], onDelete: Cascade)
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([startupId, entityType, entityId])
  @@index([startupId, userId])
  @@index([startupId, createdAt])
  @@index([startupId, action])
  @@index([entityType, entityId])
}

// ============================================================================
// INVENTORY MASTER MODELS
// ============================================================================

model ItemMaster {
  id                  String   @id @default(cuid())
  startupId           String
  itemName            String
  alias               String?
  hsnSac              String? // HSN for goods, SAC for services
  unit                String? // e.g., "PCS", "KG", "LTR", "NOS"
  defaultSalesRate    Decimal? @default(0)
  defaultPurchaseRate Decimal? @default(0)
  gstRatePercent      Decimal? @default(0) // Default GST rate for this item
  description         String?
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  startup        Startup                @relation(fields: [startupId], references: [id], onDelete: Cascade)
  inventoryLines VoucherInventoryLine[]

  @@unique([startupId, itemName])
  @@index([startupId])
  @@index([startupId, hsnSac])
}

model WarehouseMaster {
  id        String   @id @default(cuid())
  startupId String
  name      String
  alias     String?
  address   String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  startup        Startup                @relation(fields: [startupId], references: [id], onDelete: Cascade)
  inventoryLines VoucherInventoryLine[]

  @@unique([startupId, name])
  @@index([startupId])
}

model VoucherInventoryLine {
  id             String   @id @default(cuid())
  voucherId      String
  itemId         String
  warehouseId    String
  quantity       Decimal
  rate           Decimal
  amount         Decimal // quantity * rate - discount
  discountAmount Decimal? @default(0)
  gstRatePercent Decimal? // Override item's default GST rate if needed
  batchNumber    String?
  narration      String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  voucher   Voucher         @relation(fields: [voucherId], references: [id], onDelete: Cascade)
  item      ItemMaster      @relation(fields: [itemId], references: [id], onDelete: Cascade)
  warehouse WarehouseMaster @relation(fields: [warehouseId], references: [id], onDelete: Cascade)

  @@index([voucherId])
  @@index([itemId])
  @@index([warehouseId])
}
